syntax = "proto3";

package reddit.coreplatform.events.subreddit.v1;

import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";
import "reddit/coreplatform/events/common/v1/actor.proto";
import "reddit/coreplatform/subreddit/v1/subreddit.proto";
import "reddit/coreplatform/subreddit/v1/subreddit_service.proto";
import "validate/validate.proto";

option go_package = "github.snooguts.net/reddit/core-platform-events/go/subreddit/v1;subreddit";
option java_multiple_files = true;
option java_outer_classname = "SubredditProto";
option java_package = "com.reddit.coreplatform.events.subreddit.v1";

// An event which encapsulates a single instance of a subreddit entity modification. A single update event is emitted
// per subreddit update, regardless of the number of attributes that are modified. This is not triggered on subreddit
// creation, but will be triggered on any subsequent changes to that subreddit.
message SubredditUpdateEvent {
  // A subreddit thing entity. All fields on this subreddit instance are eventually consistent, with the exception of those
  // explicitly referenced by the `updated_fields` field of this message. Updated fields are always strongly consistent
  // at the moment this event was emitted. Storage of the subreddit model in systems external to core-platform must abide
  // by the `max_retention` policy defined on any of its fields.
  reddit.coreplatform.subreddit.v1.Subreddit subreddit = 1;

  // A field mask containing a list of all fields that were updated on the subreddit in this event.
  // Fields denoted in the field mask are guaranteed to be consistent at the time this event was triggered.
  // The precision of this mask is limited to only the root fields on a subreddit message. It it makes no guarantee to convey
  // if or which nested fields may have changed during an update.
  google.protobuf.FieldMask updated_fields = 2;

  // The actor that triggered this event
  reddit.coreplatform.events.common.v1.Actor updated_by = 3;

  // The UTC timestamp of the instance at which this event was triggered and successfully persisted to
  // any relevant datastore.
  google.protobuf.Timestamp updated_at = 4;

  // The version ID of this subreddit update. This is a monotonically increasing integer that is incremented
  // on every update to this subreddit. On overflow (after 2^31-1 updates), the version ID will reset to 0.
  int32 version_id = 5;
}

// An event which encapsulates a single instance of a subreddit entity creation. This event will not be triggered
// on any subsequent changes to a subreddit.
message SubredditCreateEvent {
  // A subreddit thing entity. The fields set on this subreddit instance reflect a combination of the attributes supplied
  // during the create and the default values for any unset fields. This is an exact representation of the entity at the
  // time of creation. This event will not reflect any modifications made to a subreddit immediately after creation.
  // Storage of the subreddit model in systems external to core-platform must abide by the `max_retention` policy defined
  // on any of its fields.
  reddit.coreplatform.subreddit.v1.Subreddit subreddit = 1;

  // The actor that triggered this event
  reddit.coreplatform.events.common.v1.Actor created_by = 2;

  // The UTC timestamp of the instance at which this event was triggered and successfully persisted to
  // any relevant datastore.
  google.protobuf.Timestamp created_at = 3;
}

// An event that is triggered after successful completion of a subreddit subscribe or unsubscribe operation.
// It contains information on an account subscribing to or unsubscribing from a subreddit.
message SubredditSubscriptionUpdateEvent {
  // The ID corresponding to the subscribe or unsubscribe operation that can be used to look up the operation status.
  string operation_id = 1 [(validate.rules).string.uuid = true];

  // Subscription information containing type of update, account ID, and subreddit ID
  oneof subscription {
    // Used for a subscribe event
    reddit.coreplatform.subreddit.v1.SubscribeToSubredditRequest subscribe = 2;
    // Used for an unsubscribe event
    reddit.coreplatform.subreddit.v1.UnsubscribeFromSubredditRequest unsubscribe = 3;
  }

  // The actor that triggered this event.
  reddit.coreplatform.events.common.v1.Actor updated_by = 4;

  // The UTC timestamp of the instance at which the initial operation was requested.
  google.protobuf.Timestamp requested_at = 5;

  // The UTC timestamp of the instance at which this event was triggered and successfully persisted to
  // any relevant datastore.
  google.protobuf.Timestamp completed_at = 6;
}
